<!DOCTYPE html>
<html>
  <head>
      <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
      <title>Spring Boot WebSocket Chat Application | CalliCoder</title>
     
      <style>
			body {
				font-family: Monospace;
				background-color: #000;
				color: #fff;
				margin: 0px;
				overflow: hidden;
			}
			#info {
				color: #fff;
				position: absolute;
				top: 10px;
				width: 100%;
				text-align: center;
				z-index: 100;
				display:block;
			}
			#info a {
				color: #046;
				font-weight: bold;
			}
			.hidden {
			    display: none;
			}	
	
		</style>
      	<script src="js/build/three.js"></script>

		<script src="js/js/libs/inflate.min.js"></script>
		<script src="js/js/loaders/FBXLoader.js"></script>

		<script src="js/js/controls/OrbitControls.js"></script>
		<script src="js/js/loaders/TDSLoader.js"></script>
		<script src="js/js/WebGL.js"></script>
		<script src="js/js/libs/stats.min.js"></script>
  </head>
  <body>
  	 <div id="username-page">
        <div class="username-page-container">
            <h1 class="title">Type your username</h1>
            <form id="usernameForm" name="usernameForm">
                <div class="form-group">
                    <input type="text" id="name" placeholder="Username" autocomplete="off" class="form-control" />
                </div>
                <div class="form-group">
                    <button type="submit" class="accent username-submit">Start Chatting</button>
                </div>
            </form>
        </div>
    </div>

     <div id="container" class="hidden">    	
        
    </div>
	

   
		
		
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
   
   <script>
   'use strict';

   var usernamePage = document.querySelector('#username-page');
   var chatPage = document.querySelector('#container');
   var usernameForm = document.querySelector('#usernameForm');
   var messageForm = document.querySelector('#messageForm');
   var messageInput = document.querySelector('#message');
   var messageArea = document.querySelector('#messageArea');
   var connectingElement = document.querySelector('.connecting');
	var doit=false;
   var stompClient = null;
   var username = null;

   var colors = [////!!! 
       '#2196F3', '#32c787', '#00BCD4', '#ff5652',
       '#ffc107', '#ff85af', '#FF9800', '#39bbb0'
   ];


   function connect(event) {
       username = document.querySelector('#name').value.trim();

       if(username) {
           usernamePage.classList.add('hidden');
           chatPage.classList.remove('hidden');

           var socket = new SockJS('/ws');
           stompClient = Stomp.over(socket);
           

           stompClient.connect({}, init, onError);
       }
       event.preventDefault();
       console.log("Connect");
       onConnected();
   }


   function onConnected() {
       // Subscribe to the Public Topic
       stompClient.subscribe('/topic/public', onMessageReceived);

       // Tell your username to the server
       stompClient.send("/app/chat.addUser",
           {},
           JSON.stringify({sender: username, type: 'JOIN'})
       )
       
       connectingElement.classList.add('hidden');
       console.log("onConnect");
     
      
   }


   function onError(error) {
	   console.log("Error");
   }

	// function sendMessage(event) 
   function sendMessage(event) {
      // var messageContent = messageInput.value.trim();
       var messageContent = event;
       if(messageContent && stompClient) {
           var chatMessage = {
               sender: username,
               content: messageInput,
               type: 'Position'
           };
			//Console.log(chatMessage);
           stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
           messageInput.value = 0;
       }
    	   event.preventDefault();
   }


   function onMessageReceived(payload) {
       var message = JSON.parse(payload.body);

       var messageElement = document.createElement('li');

       if(message.type === 'JOIN') {
           messageElement.classList.add('event-message');
           message.content = message.sender + ' joined!';
       } else if (message.type === 'LEAVE') {
           messageElement.classList.add('event-message');
           message.content = message.sender + ' left!';
       } else {
           messageElement.classList.add('chat-message');

           var avatarElement = document.createElement('i');
           var avatarText = document.createTextNode(message.sender[0]);
           avatarElement.appendChild(avatarText);
           avatarElement.style['background-color'] = getAvatarColor(message.sender);

           messageElement.appendChild(avatarElement);

           var usernameElement = document.createElement('span');
           var usernameText = document.createTextNode(message.sender);
           usernameElement.appendChild(usernameText);
           messageElement.appendChild(usernameElement);
       }

       var textElement = document.createElement('p');
       var messageText = document.createTextNode(message.content);
       textElement.appendChild(messageText);

       messageElement.appendChild(textElement);

       messageArea.appendChild(messageElement);
       messageArea.scrollTop = messageArea.scrollHeight;
   }


   function getAvatarColor(messageSender) {
       var hash = 0;
       for (var i = 0; i < messageSender.length; i++) {
           hash = 31 * hash + messageSender.charCodeAt(i);
       }

       var index = Math.abs(hash % colors.length);
       return colors[index];
   }

   usernameForm.addEventListener('submit', connect, true)
  // messageForm.addEventListener('submit', sendMessage, true)

  
			var container = document.getElementById( 'container' );
			var mouseHelper;
			var intersection = {
					intersects: false,
					point: new THREE.Vector3(),
					normal: new THREE.Vector3()					
				};
				var emitter ;
			var plasmaBalls = [];
			var target;
			var mouse = new THREE.Vector2();
			var loader,camera ;
			var raycaster;
			var container, stats, controls;
			var camera, scene, light;
			var renderer = new THREE.WebGLRenderer();
			var player;
			 var speed = 50;
             var clock = new THREE.Clock();
             var delta = 0;
			 var controls = {
                          moveForward: false,
                          moveBackward: false,
                          moveLeft: false,
                          moveRight: false,
                          Tower_rotation_r:false,
                          Tower_rotation_l:false,
                          Rotation_base_r:false,
                          Rotation_base_l:false
                      };
			// camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 0.01, 10000 );
			var mixer;
			var Tank={
				positionX:0,
				positionY:0,
				positionZ:0,
				tower:"",
				body:"",
				hp:""
			};
//			init();
			animate();

			function init() {

				//container = document.createElement( 'div' );
				document.body.appendChild( container );

				camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 0.01, 10000 );
				camera.position.set( 1,50, 0 );
				//camera.rotation.set(100,10,0);

				controls = new THREE.OrbitControls(camera);
				controls.target.set( 100, 15, 0 );
				controls.update();

				scene = new THREE.Scene();
				scene.background = new THREE.Color( 0xa0a0a0 );
				scene.fog = new THREE.Fog( 0xa0a0a0, 200, 1000 );

				light = new THREE.HemisphereLight( 0xffffff, 0x444444 );
				light.position.set( 0, 200, 0 );
				scene.add( light );

				light = new THREE.DirectionalLight( 0xffffff );
				light.position.set( 0, 200, 100 );
				light.castShadow = true;
				light.shadow.camera.top = 180;
				light.shadow.camera.bottom = - 100;
				light.shadow.camera.left = - 120;
				light.shadow.camera.right = 120;
				scene.add( light );
				//line
				// scene.add( new THREE.CameraHelper( light.shadow.camera ) );
				//document.addEventListener( 'keydown', onKeyDown, false );
				document.addEventListener( 'keydown', onKeyDown, false );
				document.addEventListener( 'keyup', onKeyUp, false );

			//	document.addEventListener( 'mouse', mouse);


				 window.addEventListener("mousedown", onMouseDown);
			//	window.addEventListener( 'mousemove', onTouchMove );
			//	window.addEventListener( 'touchmove', onTouchMove );

				// ground
				var mesh = new THREE.Mesh( new THREE.PlaneBufferGeometry( 2000, 2000 ), new THREE.MeshPhongMaterial( { color: 0x999999, depthWrite: false } ) );
				mesh.rotation.x = - Math.PI / 2;
				mesh.receiveShadow = true;
				scene.add( mesh );

				var grid = new THREE.GridHelper( 2000, 20, 0x000000, 0x000000 );
				grid.material.opacity = 0.2;
				grid.material.transparent = true;
				scene.add( grid );



				 loader = new THREE.TextureLoader();
					var normal = loader.load( 'js/models/3ds/portalgun/textures/PAS_Cret.jpg' );

					 loader = new THREE.FBXLoader();
						loader.setResourcePath( 'js/models/3ds/portalgun/textures/' );


				// model terrain

				loader.load( 'js/models/fbx/terrain.fbx', function ( object ) {

						mixer = new THREE.AnimationMixer( object );

				//	var action = mixer.clipAction( object.animations[ 0 ] );
				//	action.play();

					object.traverse( function ( child ) {

						if ( child.isMesh ) {

							child.castShadow = true;
							child.receiveShadow = true;

						}

					} );
					object.position.x=210;
					scene.add( object );

				} );

				//
				 loader = new THREE.TextureLoader();
					var normal = loader.load( 'js/models/3ds/portalgun/textures/PAS_Cret.jpg' );

					 loader = new THREE.FBXLoader();
						loader.setResourcePath( 'js/models/3ds/portalgun/textures/' );


				// model terrain

				loader.load( 'js/models/fbx/terrain.fbx', function ( object ) {

						mixer = new THREE.AnimationMixer( object );

				//	var action = mixer.clipAction( object.animations[ 0 ] );
				//	action.play();

					object.traverse( function ( child ) {

						if ( child.isMesh ) {

							child.castShadow = true;
							child.receiveShadow = true;

						}

					} );
					object.position.x=210;
					object.position.z=310;
					scene.add( object );

				} );

				//t26
				//
				 loader = new THREE.TextureLoader();
					var normal = loader.load( 'js/models/3ds/portalgun/textures/Tank_Alpha.jpg' );

					 loader = new THREE.FBXLoader();
						loader.setResourcePath( 'js/models/3ds/portalgun/textures/' );


				// model

				loader.load( 'js/models/fbx/t26_head.fbx', function ( object ) {

					Tank.head=object;

					object.traverse( function ( child ) {

						if ( child.isMesh ) {

							child.castShadow = true;
							child.receiveShadow = true;

						}

					} );

					scene.add( object );

				} );
				//t 26

				// model

				loader.load( 'js/models/fbx/t26_stat.fbx', function ( object ) {


					Tank.stat=object;
					object.traverse( function ( child ) {

						if ( child.isMesh ) {

							child.castShadow = true;
							child.receiveShadow = true;

						}

					} );					
					scene.add( object );

				} );

				//
				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.shadowMap.enabled = true;
				container.appendChild( renderer.domElement );

				window.addEventListener( 'resize', onWindowResize, false );

				// stats
				stats = new Stats();
				container.appendChild( stats.dom );

                     emitter = new THREE.Object3D();
                    emitter.position.set(3,-5,200);
                    camera.add(emitter);


                  // onConnected();

				function onMouseDown() {
                      let plasmaBall = new THREE.Mesh(new THREE.SphereGeometry(1, 1, 1), new THREE.MeshBasicMaterial({
                        color: "aqua"
                      }));                    
                      plasmaBall.position.copy(emitter.getWorldPosition()); // start position - the tip of the weapon
                     plasmaBall.quaternion.copy(camera.quaternion); // apply camera's quaternion
                      scene.add(plasmaBall);
                      plasmaBalls.push(plasmaBall);
                    }


			}


                function onKeyDown( event ) {///!!!!Tank.head.rotation.y +=0.1;break;
                  var moveDistance = 50 * clock.getDelta();
                  event.stopPropagation();

                  switch ( event.keyCode ) {

                      case 38: /*up*/
                      case 87: /*W*/ ;Tank.stat.translateX( 10 );PositionSin();controls.moveForward = true; break;

                      case 40: /*down*/
                      case 83: /*S*/	controls.moveBackward = true;Tank.stat.translateX( -10 );PositionSin(); controls.moveBackward = true;break;

                      case 37: /*left*/
                      case 65: /*A*/Tank.stat.rotation.y +=0.1;controls.Rotation_base_r = true;PositionSin();  break;

                      case 39: /*right*/
                      case 68: /*D*/Tank.stat.rotation.y -=0.1;controls.Rotation_base_l = true;PositionSin(); break;

                      //case 67: /*C*/
                      //case 32: /*space*/
                      //case 17: /*ctrl*/

                  }

              }

              function onKeyUp( event ) {

                  event.stopPropagation();
                  var moveDistance = 50 * clock.getDelta();
                  switch ( event.keyCode ) {

                      case 38: /*up*/
                      case 87: /*W*/controls.moveForward = false;break;

                      case 40: /*down*/
                      case 83: /*S*/controls.moveBackward = false;break;

                      case 37: /*left*/Tank.head.rotation.y +=0.1;controls.Tower_rotation_r = false;break;
                      case 65: /*A*/

                      case 39: /*right*/Tank.head.rotation.y -=0.1;controls.Tower_rotation_l= false;break;
                      case 68: /*D*/

                      //case 67: /*C*/
                      //case 32: /*space*/
                      //case 17: /*ctrl*/
                  }



              }

				function PositionSin(){
					Tank.head.position.x=Tank.stat.position.x;
					Tank.head.position.y=Tank.stat.position.y;
					Tank.head.position.z=Tank.stat.position.z;

				}
			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			//

		function animate() {

				requestAnimationFrame( animate );
			//	console.log(Tank.head.position.x);
			//	camera.localToWorld(Tank.head.position.x,Tank.head.position.y,Tank.head.position.z);
			//	camera.position.set((Tank.head.position.x),(Tank.head.position.y)+50,Tank.head.position.z);
					var delta = clock.getDelta();

                      plasmaBalls.forEach(b => {
                        b.translateZ(-speed * delta*10); // move along the local z-axis
                      });
                console.log(Tank.head.position);      
				console.log(Tank.stat.position);
              	// sendMessage(Tank.stat.position);//function problemþü

				if ( mixer ) mixer.update( delta )
				renderer.render( scene, camera );
				
				stats.update();
				
			}

		</script>
  </body>
</html>